<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Gestión de Roles | Admin</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <link rel="stylesheet" th:href="@{/Css/roles.css}">
    
    <style>
        /* Estilo simple para el listado */
        .card {
            border-radius: 0.5rem;
        }
        .table-responsive {
            margin-top: 1.5rem;
        }
    </style>
</head>

<body class="container py-5">

    <div th:if="${msgExito}" class="alert alert-success alert-dismissible fade show text-center" role="alert">
        <span th:text="${msgExito}">Rol guardado exitosamente.</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fa-solid fa-user-shield me-2"></i> Gestión de Roles</h5>
                    <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" 
                            data-bs-target="#rolModal" 
                            onclick="resetRolForm()">
                        <i class="fa-solid fa-plus"></i> Nuevo Rol
                    </button>
                </div>
                
                <div class="card-body">
                    <p class="text-muted mb-4">Administra los roles disponibles en el sistema.</p>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre del Rol</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="rol : ${roles}">
                                    <td th:text="${rol.id}">1</td>
                                    <td><span th:text="${rol.nombre}">CLIENTE</span></td>
                                    <td class="text-center">
                                  <button type="button" class="btn btn-sm btn-warning me-2" 
									        data-bs-toggle="modal" 
									        data-bs-target="#rolModal" 
									        th:attrappend="onclick=|loadRolData('${rol.id}', '${rol.nombre}')|">
									    <i class="fa-solid fa-edit"></i>
									</button>
									                                        
                                        <a th:href="@{/admin/roles/eliminar/{id}(id=${rol.id})}" 
                                           class="btn btn-sm btn-danger" 
                                           onclick="return confirm('¿Estás seguro de que quieres eliminar este rol? Esto podría afectar a los usuarios.')">
                                            <i class="fa-solid fa-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card-footer text-center">
                    <a th:href="@{/admin}" class="btn btn-secondary"> 
                        <i class="fa-solid fa-arrow-left"></i> Volver al Panel
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="rolModal" tabindex="-1" aria-labelledby="rolModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form th:action="@{/admin/roles}" method="post" id="rolForm">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="rolModalLabel">Crear Nuevo Rol</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              
              <input type="hidden" id="rolId" name="id" value="" />
              
              <div class="mb-3">
                <label for="rolNombre" class="form-label">Nombre del Rol:</label>
                <input type="text" class="form-control" id="rolNombre" name="nombre" 
                       placeholder="Ej: ROL_ADMIN, ROL_CLIENTE" required>
              </div>
              
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary" id="submitButton">Guardar Rol</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Función para cargar los datos del rol en el modal para edición
        function loadRolData(id, nombre) {
            // 1. Actualizar el título y el botón de submit
            document.getElementById('rolModalLabel').innerText = 'Editar Rol';
            document.getElementById('submitButton').innerText = 'Actualizar Rol';
            document.getElementById('submitButton').classList.remove('btn-primary');
            document.getElementById('submitButton').classList.add('btn-warning');

            // 2. Establecer la acción del formulario para la actualización
            const form = document.getElementById('rolForm');
            // La URL de actualización es /admin/roles/actualizar/{id}
            form.action = '/admin/roles/actualizar/' + id; 
            
            // 3. Cargar los datos en los campos
            document.getElementById('rolId').value = id;
            document.getElementById('rolNombre').value = nombre;
        }

        // Función para resetear el modal a la configuración de CREACIÓN
        function resetRolForm() {
            // 1. Limpiar el formulario y resetear el título y botón
            document.getElementById('rolForm').reset();
            document.getElementById('rolModalLabel').innerText = 'Crear Nuevo Rol';
            document.getElementById('submitButton').innerText = 'Guardar Rol';
            document.getElementById('submitButton').classList.remove('btn-warning');
            document.getElementById('submitButton').classList.add('btn-primary');

            // 2. Restablecer la acción del formulario a la ruta de guardado (creación)
            document.getElementById('rolForm').action = '/admin/roles';
            document.getElementById('rolId').value = '';
        }
        
        // Asignar la función de reseteo al cerrar el modal (por si se cierra sin guardar)
        const rolModalElement = document.getElementById('rolModal');
        rolModalElement.addEventListener('hidden.bs.modal', function () {
            resetRolForm();
        });
    </script>
</body>
</html>