<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mi Perfil | Trabajador BookFlow</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<link rel="stylesheet" th:href="@{/Css/perfilTrabajador.css}">

</head>

<body class="bg-light">

<div class="container py-5">
	<div class="row justify-content-center">
		<div class="col-lg-6">
			<h2 class="mb-5 text-primary fw-bold text-center">
				<i class="bi bi-person-gear me-2"></i> Configuración de Perfil
			</h2>

			<div class="card shadow-lg card-perfil">
				<div class="card-header bg-primary text-white">
					<h5 class="mb-0 fw-bold">Datos Personales y Acceso</h5>
				</div>
				<div class="card-body p-4">

					<form th:action="@{/trabajador/configuracion/actualizar}" th:object="${usuario}" method="post" id="formPerfil">
						<input type="hidden" th:field="*{id}">
						<input type="hidden" th:field="*{password}" id="passwordHidden">

						<div class="profile-img-container">
							<img th:src="@{${usuario.imagenUrl != null and usuario.imagenUrl != '' ? usuario.imagenUrl : '/img/default-avatar.png'}}"
							     class="profile-img" alt="Foto de perfil">
						</div>

						<div class="mb-4">
							<label class="form-label fw-semibold" for="imagenUrl">Imagen de Perfil (URL)</label>
							<input type="url" th:field="*{imagenUrl}" id="imagenUrl" class="form-control"
								   placeholder="https://">
						</div>

						<hr class="my-4">

						<div class="row g-3">
							<div class="col-md-6">
								<label for="nombre" class="form-label fw-semibold">Nombre</label>
								<input type="text" th:field="*{nombre}" id="nombre" class="form-control" required>
							</div>

							<div class="col-md-6">
								<label for="apellido" class="form-label fw-semibold">Apellido</label>
								<input type="text" th:field="*{apellido}" id="apellido" class="form-control" required>
							</div>

							<div class="col-12">
								<label for="email" class="form-label fw-semibold">Email</label>
								<input type="email" th:field="*{email}" id="email" class="form-control" required>
							</div>

							<div class="col-12">
								<label for="password" class="form-label fw-semibold text-warning-dark">Nueva Contraseña (Dejar vacío para no cambiar)</label>
								<input type="password" id="password" class="form-control" placeholder="••••••••">
							</div>

							<div class="col-12 mt-5 d-flex justify-content-between">
								<a th:href="@{/trabajador}" class="btn btn-outline-secondary btn-lg">
									<i class="bi bi-arrow-left me-2"></i> Dashboard
								</a>
								<button type="submit" class="btn btn-primary-custom btn-lg">
									<i class="bi bi-save-fill me-2"></i> Guardar Cambios
								</button>
							</div>
						</div>
					</form>

				</div>
			</div>
		</div>
	</div>
</div>

<script>
// Lógica para manejar los mensajes flash con SweetAlert2
document.addEventListener('DOMContentLoaded', function() {
    const msgExito = '[[${msgExito}]]';
    const msgError = '[[${msgError}]]';
    
    // Si la URL contiene el parámetro 'success' (típico después de un redirect)
    const urlParams = new URLSearchParams(window.location.search);
    const successParam = urlParams.get('success');

    if (msgExito && msgExito !== '') {
        Swal.fire({
            icon: 'success',
            title: '¡Éxito!',
            text: msgExito,
            timer: 3000,
            showConfirmButton: false
        });
    } else if (msgError && msgError !== '') {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: msgError,
            confirmButtonColor: '#dc3545'
        });
    } else if (successParam === 'true') {
        Swal.fire({
            icon: 'success',
            title: '¡Perfil Actualizado!',
            text: 'Tu información ha sido guardada exitosamente.',
            timer: 3000,
            showConfirmButton: false
        });
    }
});

// Lógica para validar la contraseña antes de enviar el formulario
document.getElementById('formPerfil').addEventListener('submit', function (e) {
	const passwordInput = document.getElementById('password');
	const passwordHidden = document.getElementById('passwordHidden');
	const nuevaPassword = passwordInput.value.trim();

	// 1. Si el campo de nueva contraseña está vacío, enviar vacío para que el backend lo ignore.
	if (nuevaPassword === '') {
		passwordHidden.value = ''; 
	} 
	// 2. Validación de longitud si se intenta cambiar.
    else if (nuevaPassword.length < 6) {
		e.preventDefault();
		Swal.fire({
			icon: 'warning',
			title: 'Contraseña débil',
			text: 'La contraseña debe tener al menos 6 caracteres.',
			confirmButtonColor: '#400080',
			confirmButtonText: 'Entendido'
		});
		return;
	} 
    // 3. Si es válida, actualizar el campo oculto y permitir el envío.
    else {
		passwordHidden.value = nuevaPassword;
	}
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>