<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Reporte de Ventas | BookFlow</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<link rel="stylesheet" th:href="@{/css/ventas.css}">
    </head>
<body>

<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-bold">
            <i class="bi bi-clipboard-data me-2"></i>Reporte de Ventas
        </h2>
        <a th:href="@{/admin}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left-circle me-2"></i>Volver al Panel
        </a>
    </div>

 

<div class="d-flex flex-wrap gap-2 justify-content-center mb-4">
    <a th:href="@{/admin/ventas/nueva}" class="btn btn-success">
        <i class="fa-solid fa-plus me-2"></i>Registrar Nueva Venta
    </a>

    <a th:href="@{/admin/reportes/ventas/pdf}" class="btn btn-danger shadow-sm">
        <i class="bi bi-file-earmark-pdf me-2"></i>Exportar PDF
    </a>
    <a th:href="@{/admin/reportes/ventas/excel}" class="btn btn-primary shadow-sm">
        <i class="bi bi-file-earmark-excel me-2"></i>Exportar Excel
    </a>
</div>

    <div th:if="${exito}" th:data-msg="${exito}" id="msgExito"></div>
    <div th:if="${error}" th:data-msg="${error}" id="msgError"></div>

    <div th:if="${#lists.isEmpty(ventas)}" class="alert alert-warning text-center shadow-sm">
        <i class="bi bi-exclamation-triangle me-2"></i>No hay ventas registradas aún.
    </div>

    <div th:each="venta : ${ventas}" class="card mb-4 shadow-sm border-0 rounded-3">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title text-secondary fw-semibold mb-0">
                    <i class="bi bi-receipt me-2"></i>Venta N° <span th:text="${venta.id}"></span>
                </h5>
                <span class="badge bg-info text-dark px-3 py-2">
                    <i class="bi bi-calendar-event me-1"></i>
                    <span th:text="${#temporals.format(venta.fecha, 'dd/MM/yyyy HH:mm')}"></span>
                </span>
            </div>

            <p class="mb-2">
                <strong><i class="bi bi-person-circle me-1"></i>Cliente:</strong>
                <span th:text="${venta.usuario.nombre + ' ' + venta.usuario.apellido}"></span><br>
                <strong><i class="bi bi-credit-card me-1"></i>Método de Pago:</strong>
                <span th:text="${venta.metodoPago}"></span>
            </p>

            <div class="table-responsive">
                <table class="table table-bordered align-middle text-center shadow-sm"> 
                    <thead>
                        <tr>
                            <th>Libro</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario (S/.)</th>
                            <th>Descuento (%)</th>
                            <th>Subtotal (S/.)</th>
                            <th>Stock Restante</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="detalle : ${venta.detalles}">
                            <td th:text="${detalle.libro.titulo}"></td>
                            <td th:text="${detalle.cantidad}"></td>
                            <td th:text="${#numbers.formatDecimal(detalle.precioUnitario, 2, 2)}"></td>
                            <td th:text="${detalle.libro.descuento != null ? #numbers.formatDecimal(detalle.libro.descuento.multiply(100), 2, 2) : '0.00'}"></td>
                            <td th:text="${#numbers.formatDecimal(detalle.subtotal, 2, 2)}"></td>
                            <td th:text="${detalle.libro.stock}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="text-end mt-3 fw-bold text-primary fs-5">
                Total Venta: S/. <span th:text="${#numbers.formatDecimal(venta.total, 2, 2)}"></span>
            </div>
        </div>
    </div>

    <div class="alert alert-primary text-end fw-semibold shadow-sm" th:if="${!#lists.isEmpty(ventas)}">
        <i class="bi bi-bar-chart-fill me-2"></i>
        Total General de Ventas: 
        <span th:text="${#numbers.formatDecimal(totalGeneral, 2, 2)}"></span> S/.
    </div>

    <footer class="text-center text-muted py-3 mt-4 rounded shadow-sm">
        <small>
            <i class="bi bi-book-half me-1"></i>
            Sistema BookFlow © 2025 — Desarrollado por <strong>Yaxon Calle</strong>
        </small>
    </footer>

</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const exito = document.querySelector("#msgExito");
        const error = document.querySelector("#msgError");

        if (exito) {
            Swal.fire({
                icon: "success",
                title: "¡Éxito!",
                text: exito.dataset.msg,
                confirmButtonColor: "rgb(64, 0, 128)" // Púrpura oscuro para el botón
            });
        }

        if (error) {
            Swal.fire({
                icon: "error",
                title: "Error",
                text: error.dataset.msg,
                confirmButtonColor: "#dc3545"
            });
        }
    });
</script>

</body>
</html>